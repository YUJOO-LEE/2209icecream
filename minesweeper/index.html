<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>지뢰찾기</title>
  <style>
    #select-screen {
      display: block;
    }
    #game-screen {
      display: none;
    }
    table {
      border-collapse: collapse;
    }
    td {
      border: 1px solid white;
      text-align: center;
      line-height: 1.1rem;
      width: 1.1rem;
      height: 1.1rem;
      background-color: lightgray;
    }
    td.opened {
      background-color: white;
    }
    td.flag {
      background-color: red;
    }
    td.question {
      background-color: orange;
    }
  </style>
</head>
<body>
  <main>
    <section id="select-screen">
      <form id="select-game">
        <select name="select-box">
          <option value="9">초급 (9 * 9)</option>
          <option value="16">중급 (16 * 16)</option>
          <option value="30">고급 (30 * 30)</option>
        </select>
        <button>시작</button>
      </form>
    </section>
    <section id="game-screen">
      <table id="table">
        <tbody></tbody>
      </table>
      <div id="result"></div>
    </section>
  </main>
  <script>
    const $selectScreen = document.querySelector('#select-screen');
    const $selectGame = document.querySelector('#select-game');
    const $gameScreen = document.querySelector('#game-screen');
    const $tbody = document.querySelector('#table tbody');
    const $result = document.querySelector('#result');
    let box = [];
    let game = null;
    let clickable = false;

    const CODE = {
      OPENED : 0,
      DEFAULT : -1,
      QUESTION : -2,
      FLAG : -3,
      QUESTION_MINE : -4,
      FLAG_MINE : -5,
      MINE : -6,
    }

    class Game {
      constructor(size) { //신규 게임
        this.size = Number(size) * Number(size);
        this.lineSize = Number(size);
        this.mine = Math.round(Number(size) * Number(size) / 5);
        this.boxList = [];
        this.start();
      }

      start() { //게임 시작
        this.changeScreen('game');
        this.createBox();
      }

      onLeftClick(e) {
        const trId = e.target.parentNode.rowIndex;
        const tdId = e.target.cellIndex
        let thisDate = game.boxList[trId][tdId];  //Data에서 현재값 불러오기

        if (!clickable || (thisDate !== CODE.DEFAULT && thisDate !== CODE.MINE)) {  //일반칸 아니면 좌클릭 방지
          return;
        }
        if (game.boxList[trId][tdId] <= CODE.QUESTION_MINE) {  //지뢰라면
          for(let i = 0 ; i < game.boxList.length ; i++){
            for(let j = 0 ; j < game.boxList[i].length ; j++){
              if (game.boxList[i][j] <= CODE.QUESTION_MINE){
                $tbody.children[i].childNodes[j].textContent = 'O';
              }
            }
          }
          $result.textContent = '꽝!';
          clickable = false;

        }
        if (game.boxList[trId][tdId] >= CODE.FLAG) {  //지뢰가 아니라면
          //e.target.textContent = '*';
        }
      }

      onRightClick(e) {
        e.preventDefault();
        const trId = e.target.parentNode.rowIndex;  //선택한 줄 위치
        const tdId = e.target.cellIndex;  //선택한 칸 위치
        let thisDate = game.boxList[trId][tdId];  //Data에서 현재값 불러오기
        if (!clickable || thisDate > CODE.DEFAULT) {  //오픈된칸 우클릭 방지
          return;
        }
        
        if (thisDate === CODE.DEFAULT) {  //지뢰없는 일반칸일때
          e.target.className = 'question';
          e.target.textContent = '?';
          game.boxList[trId][tdId] = CODE.QUESTION;
        } else if (thisDate === CODE.QUESTION) { //지뢰없는 물음표칸일때
          e.target.className = 'flag';
          e.target.textContent = '!';
          game.boxList[trId][tdId] = CODE.FLAG;
        } else if (thisDate === CODE.FLAG) { //지뢰없는 깃발칸일때
          e.target.className = '';
          e.target.textContent = '';
          game.boxList[trId][tdId] = CODE.DEFAULT;
        } else if (thisDate === CODE.MINE) { //지뢰있는 일반칸일때
          e.target.className = 'question';
          e.target.textContent = '?';
          game.boxList[trId][tdId] = CODE.QUESTION_MINE;
        } else if (thisDate === CODE.QUESTION_MINE) { //지뢰있는 물음표칸일때
          e.target.className = 'flag';
          e.target.textContent = '!';
          game.boxList[trId][tdId] = CODE.FLAG_MINE;
        } else if (thisDate === CODE.FLAG_MINE) { //지뢰있는 깃발칸일때
          e.target.className = '';
          e.target.textContent = '';
          game.boxList[trId][tdId] = CODE.MINE;
        }
        console.log(thisDate, game.boxList);
      }

      createBox() { //새 게임 출력
        const cellList = new Array(this.size).fill(-1); //시작한 게임 갯수만큼 배열 저장
        for (let i = 0 ; i < this.mine ; i++) { //지뢰 갯수만큼 랜덤 값 뽑아서 인덱스로 사용
          const randomIndex = Math.floor(Math.random() * cellList.length);
          if (cellList[randomIndex] === -6) {  //이미 값 있으면 넘어감
            i++;
          } else {  //값 없는 위치에 값 추가
            cellList[randomIndex] = -6;
          }
        }
        let cellListCopy;//한줄 길이만큼만 잘라서 2차 배열로 보관
        for (let i = 0 ; i < this.lineSize ; i++) {
          cellListCopy = cellList.slice(i * this.lineSize, (i + 1) * this.lineSize);
          this.boxList.push(cellListCopy);
        }

        /* 테이블 그리기 */
        for (let i = 0 ; i < this.lineSize ; i++) { //한줄 사이즈만큼 tr만들기
          const $tr = document.createElement('tr');
          for (let j = 0 ; j < this.lineSize ; j++) { //한줄 사이즈만큼 td만들기
            const $td = document.createElement('td');
            if (this.boxList[i][j] === -6) {  //테스트용
              $td.textContent = 'X';
            }
            $tr.append($td);
          }
          $tbody.append($tr);
          $tbody.addEventListener('click', this.onLeftClick);
          $tbody.addEventListener('contextmenu', this.onRightClick);
        }

      }

      changeScreen(screen) {  //화면 전환
        if (screen === 'game') {
          $selectScreen.style.display = 'none';
          $gameScreen.style.display = 'block';
          clickable = true;
        } else if (screen === 'select') {
          $selectScreen.style.display = 'block';
          $gameScreen.style.display = 'none';
        }
      }
    }

    const onGame = (e) => { //난이도 선택 후 이벤트
      e.preventDefault();
      size = e.target['select-box'].value;
      game = new Game(size);
    }

    $selectGame.addEventListener('submit', onGame);
  </script>
</body>
</html>