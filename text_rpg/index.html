<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>텍스트 RPG</title>
  <style>
    * {
      font-size: 1.5rem;
    }
  </style>
</head>
<body>
  <main>
    <section>
      <form id="start-screen">
        <input id="name-input" type="text" placeholder="이름을 입력 해 주세요.">
        <button id="start">시작</button>
      </form>
    </section>
    <div id="screen">
      <section id="hero-stat">
        <span id="hero-name"></span>
        <span id="hero-level"></span>
        <span id="hero-hp"></span>
        <span id="hero-xp"></span>
        <span id="hero-att"></span>

        <form id="game-menu" style="display: none;">
          <button id="adventure">모험</button>
          <button id="rest">휴식</button>
          <button id="exit">종료</button>
        </form>
        <form id="battle-menu" style="display: none;">
          <button id="attack">공격</button>
          <button id="heal">회복</button>
          <button id="run">도망</button>
        </form>
      </section>
      <section>
        <div id="msg"></div>
        <div id="monster-stat">
          <span id="monster-name"></span>
          <span id="monster-hp"></span>
          <span id="monster-att"></span>
        </div>
      </section>
    </div>
  </main>
  <script>
    const $startScreen = document.querySelector('#start-screen');
    const $gameMenu = document.querySelector('#game-menu');
    const $battleMenu = document.querySelector('#battle-menu');
    const $msg = document.querySelector('#msg');

    const $heroStat = { //주인공 스탯 출력 부분
      name : document.querySelector('#hero-name'),
      level :  document.querySelector('#hero-level'),
      hp :  document.querySelector('#hero-hp'),
      xp :  document.querySelector('#hero-xp'),
      att :  document.querySelector('#hero-att'),
    }

    const $monsterStat = {  //마주친 몬스터 스탯 출력 부분
      name : document.querySelector('#monster-name'),
      hp :  document.querySelector('#monster-hp'),
      att :  document.querySelector('#monster-att'),
    }

    class Game {
      constructor(name) { //신규 게임 생성
        this.hero = null;
        this.monster = null;
        this.monsterList = [
          { name: '슬라임', hp: 25, att: 10, xp: 10 },
          { name: '스켈레톤', hp: 50, att: 15, xp: 20 },
          { name: '마왕', hp: 150, att: 35, xp: 50 },
        ];
        this.start(name);
      }
      start(name) { //게임 시작
        $gameMenu.addEventListener('click', this.onGameMenu);
        $battleMenu.addEventListener('click', this.onBattleMenu);
        this.hero = new Hero(this, name);
        this.updateHero();
        this.changeScreen('game');
        this.showMessage('');
      }
      changeScreen(screen) {  //화면 전환용, function 함수
        if (screen === 'start') {
          $startScreen.style.display = 'block';
          $gameMenu.style.display = 'none';
          $battleMenu.style.display = 'none';
        } else if (screen === 'game') {
          $startScreen.style.display = 'none';
          $gameMenu.style.display = 'block';
          $battleMenu.style.display = 'none';
        } else if (screen === 'battle') {
          $startScreen.style.display = 'none';
          $gameMenu.style.display = 'none';
          $battleMenu.style.display = 'block';
        }
      }
      onGameMenu = (e) => { //게임 메뉴에서 선택, 함수 바깥쪽 this를 쓰기위해 => 함수 사용
        e.preventDefault();
        const selected = e.target.id; //어떤 버튼 눌렀는지
        if (selected === 'adventure') { //'모험' 선택
          this.changeScreen('battle');
          const randomIndex = Math.floor(Math.random() * this.monsterList.length);
          const randomMonster = this.monsterList[randomIndex];  //몬스터 리스트에서 몬스터 뽑아서
          this.monster = new Monster (  //상대 몬스터 생성
            this,
            randomMonster.name,
            randomMonster.hp, 
            randomMonster.xp, 
            randomMonster.att 
          );
          this.updateMonster();
          this.showMessage(`몬스터를 마주쳤다! ${this.monster.name}인 것 같다!`);
        } else if (selected === 'rest') { //'휴식' 선택
          this.hero.hp = this.hero.maxHp;
          this.updateHero();
          this.showMessage(`체력을 모두 회복했다!`);
        } else if (selected === 'exit') { //'종료' 선택
          this.quit();
        }
      }
      onBattleMenu = (e) => { //모험 메뉴에서 선택
        e.preventDefault();
        const selected = e.target.id;
        const { hero, monster } = this;

        if (selected === 'attack') {  //'공격' 선택
          hero.attack(monster);
          monster.attack(hero);
          hero.onFight(hero, monster, 'attack');
          this.updateHero();
          this.updateMonster();
        } else if (selected === 'heal') { //'회복' 선택
          hero.heal(monster);
          this.updateHero();
          this.updateMonster();
        } else if (selected === 'run') {  //'도망' 선택
          this.monster = null;
          this.updateMonster();
          this.showMessage(`도망갔다.`);
          this.changeScreen('game');
        }
      }
      updateHero() { //캐릭터 스탯 화면 출력
        const { hero } = this;   //hero = this.hero
        if (hero === null) {
          $heroStat.name.textContent = '';
          $heroStat.level.textContent = '';
          $heroStat.hp.textContent = '';
          $heroStat.xp.textContent = '';
          $heroStat.att.textContent = '';
          return;
        }
          $heroStat.name.textContent = hero.name;
          $heroStat.level.textContent = `${hero.level}Lv`;
          $heroStat.hp.textContent = `HP : ${hero.hp} / ${hero.maxHp}`;
          $heroStat.xp.textContent = `XP : ${hero.xp} / ${hero.level * 15}`;
          $heroStat.att.textContent = `ATT : ${hero.att}`;
      }
      updateMonster() { //몬스터 스탯 화면 출력
        const { monster } = this;
        if (monster === null) {
          $monsterStat.name.textContent = '';
          $monsterStat.hp.textContent = '';
          $monsterStat.att.textContent = '';
          return;
        }
          $monsterStat.name.textContent = monster.name;
          $monsterStat.hp.textContent = `HP : ${monster.hp} / ${monster.hp}`;
          $monsterStat.att.textContent = `ATT : ${monster.att}`;
      }
      showMessage(text) { //메세지 출력 기능
        $msg.textContent = text;
      }
      quit() {  //게임 종료 (전체 초기화)
        this.hero = null;
        this.monster = null;
        game = null;
        this.updateHero();
        this.updateMonster();
        $gameMenu.removeEventListener('click', this.onGameMenu);
        $battleMenu.removeEventListener('click', this.onBattleMenu);
        this.changeScreen('start');
      }
    }

    class Unit {  //Hero, Monster Class 공통 부분
      constructor(game, name, hp, xp, att) {
        this.game = game;
        this.name = name;
        this.hp = hp;
        this.xp = xp;
        this.att = att;
      }
      attack(target) {
        target.hp -= this.att;
      }
      onFight(hero, monster, parent) {  //게임 종료여부 검사
        if (hero.hp < 1) {
          this.game.showMessage(`${hero.level}레벨에서 전사했다. 새로운 캐릭터를 생성하세요.`);
          this.game.quit();
          return;
        } else if (monster.hp < 1) {
          this.game.showMessage(`${monster.name}를 처치했다!`);
          hero.getXp(monster);
          this.game.monster = null;
          this.game.changeScreen('game');
          return;
        } else if (parent === 'attack') { //싸우던 중일때
          this.game.showMessage(`${hero.att}의 데미지를 주고, ${monster.att}의 데미지를 받았다!`);
        } else if (parent === 'heal') { //회복하던 중일때
          this.game.showMessage(`20을 회복하였지만, ${monster.att}의 데미지를 받았다!`);
        }
      }
    }

    class Hero extends Unit { //캐릭터 생성
      constructor(game, name) {
        super(game, name, 100, 0, 10);  //공통부분 이용하고
        this.level = 1; //공통부분에 없는 부분만 별도 추가
        this.maxHp = 100;
      }
      heal(monster) { //20씩 회복하지만 monster에게 받은 수치만큼 다시 맞음
        if (this.hp === this.maxHp) {
          this.game.showMessage(`더 이상 회복 할 수 없다.`);
          return;
        }
        this.hp += 20;
        if (this.hp > this.maxHp) {
          this.hp = this.maxHp;
        }
        this.hp -= monster.att;
        super.onFight(this, monster, 'heal'); //게임 종료여부 검사
      }
      getXp(monster) {
        this.xp += monster.xp;
        if (this.xp >= this.level * 15) { //레벨 업
          this.xp = 0;
          this.level += 1;
          this.maxHp += 5;
          this.att += 5;
          this.hp = this.maxHp;
          this.game.showMessage(`레벨 업! ${this.level}레벨이 되었습니다.`);
        }
      }
      attack(target) {
        super.attack(target);
      }
    }

    class Monster extends Unit {  //몬스터 생성
      constructor(game, name, hp, xp, att) {
        super(game, name, hp, xp, att);
      }
    }

    let game = null;
    
    const start = (e) => {
      e.preventDefault();
      const name = e.target['name-input'].value;  //닉네임 값 받아와서
      game = new Game(name);  //새로운 게임 생성
    }

    $startScreen.addEventListener('submit', start); //닉네임 입력 후 게임시작 이벤트
  </script>
</body>
</html>